// Google Apps Script for handling UPI submissions and postback
// Deploy this as a Web App with "Anyone" access

// Configuration
const SHEET_ID = '1eQkvxvL1YD-dN-ktKNwUtYWHDSA74wY0kzrBJ7NkRL4';
const SHEET_NAME = 'Submissions';

// Security Token - Change this to a random secret value!
const SECURITY_TOKEN = 'EbinTech2026Secret'; // CHANGE THIS!

// Handle GET requests (for status checking AND postback)
function doGet(e) {
  try {
    const params = e.parameter || {};
    Logger.log('GET request received with params: ' + JSON.stringify(params));
    
    const action = params.action;
    const upiId = params.upi;
    const clickId = params.click_id;
    const event = params.event;
    const status = params.status;
    const token = params.token;
    
    // Check if this is a postback from the panel
    if (clickId && (event === 'conversion' || status === 'approved')) {
      Logger.log('Postback request received for click_id: ' + clickId);
      
      // Verify security token
      if (token !== SECURITY_TOKEN) {
        Logger.log('SECURITY: Invalid or missing token. Received: ' + token);
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: 'Unauthorized: Invalid security token'
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      Logger.log('SECURITY: Token verified. Processing postback...');
      return handlePostback({ click_id: clickId, status: 'approved' });
    }
    
    // Check if this is a status check request (no token needed for public status checks)
    if (action === 'check' && upiId) {
      Logger.log('Processing status check for UPI: ' + upiId);
      return checkStatus(upiId);
    }
    
    Logger.log('Invalid request - no valid parameters found');
    return ContentService.createTextOutput(JSON.stringify({
      error: 'Invalid request',
      received: params,
      help: 'Use ?click_id=XXX&status=approved&token=XXX for postback OR ?action=check&upi=XXX for status'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('Error in doGet: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Handle POST requests (for submissions)
function doPost(e) {
  try {
    Logger.log('POST request received');
    const data = JSON.parse(e.postData.contents);
    Logger.log('POST data: ' + JSON.stringify(data));
    
    // Check if this is a postback from the panel
    if (data.click_id && data.status === 'approved') {
      // Verify token for POST postback as well
      if (data.token !== SECURITY_TOKEN) {
        Logger.log('SECURITY: Invalid or missing token in POST');
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: 'Unauthorized: Invalid security token'
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      Logger.log('Processing POST postback for click_id: ' + data.click_id);
      return handlePostback(data);
    }
    
    // Otherwise, it's a new UPI submission (no token needed)
    Logger.log('Processing new UPI submission');
    return handleSubmission(data);
    
  } catch (error) {
    Logger.log('Error in doPost: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Handle new UPI submission
function handleSubmission(data) {
  const sheet = getSheet();
  const timestamp = new Date();
  
  Logger.log('Handling submission for UPI: ' + data.upiId + ', Click ID: ' + data.clickId);
  
  // Allow multiple submissions from same UPI (removed duplicate check)
  // Each submission gets a unique Click ID
  
  // Add new row
  sheet.appendRow([
    timestamp,
    data.upiId,
    data.clickId,
    data.status || 'pending',
    '', // Conversion timestamp (empty initially)
    '' // Notes
  ]);
  
  Logger.log('UPI submission saved successfully');
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: 'UPI ID registered successfully'
  })).setMimeType(ContentService.MimeType.JSON);
}

// Handle postback from campaign panel
function handlePostback(data) {
  const sheet = getSheet();
  const clickId = data.click_id;
  
  Logger.log('Looking for click_id: ' + clickId);
  
  // Find row with this click_id
  const rowIndex = findRowByClickId(sheet, clickId);
  
  if (rowIndex > 0) {
    // Update status to 'tracked' and add conversion timestamp
    sheet.getRange(rowIndex, 4).setValue('tracked'); // Status column
    sheet.getRange(rowIndex, 5).setValue(new Date()); // Conversion timestamp
    
    const upiId = sheet.getRange(rowIndex, 2).getValue();
    Logger.log('Conversion tracked successfully for UPI: ' + upiId + ', Click ID: ' + clickId);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: 'Conversion tracked',
      click_id: clickId,
      upi_id: upiId
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  Logger.log('Click ID not found: ' + clickId);
  
  return ContentService.createTextOutput(JSON.stringify({
    success: false,
    message: 'Click ID not found',
    click_id: clickId
  })).setMimeType(ContentService.MimeType.JSON);
}

// Check status of a UPI ID
function checkStatus(upiId) {
  const sheet = getSheet();
  const rowIndex = findRowByUPI(sheet, upiId);
  
  if (rowIndex > 0) {
    const row = sheet.getRange(rowIndex, 1, 1, 6).getValues()[0];
    
    Logger.log('Status found for UPI: ' + upiId);
    
    return ContentService.createTextOutput(JSON.stringify({
      found: true,
      upiId: row[1],
      clickId: row[2],
      status: row[3],
      timestamp: row[0],
      conversionTime: row[4] || null
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  Logger.log('No data found for UPI: ' + upiId);
  
  return ContentService.createTextOutput(JSON.stringify({
    found: false
  })).setMimeType(ContentService.MimeType.JSON);
}

// Helper: Get or create sheet
function getSheet() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName(SHEET_NAME);
  
  // Create sheet if it doesn't exist
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    sheet.appendRow([
      'Timestamp',
      'UPI ID',
      'Click ID',
      'Status',
      'Conversion Time',
      'Notes'
    ]);
    sheet.getRange(1, 1, 1, 6).setFontWeight('bold');
  }
  
  return sheet;
}

// Helper: Find row by UPI ID (returns most recent if multiple exist)
function findRowByUPI(sheet, upiId) {
  const data = sheet.getDataRange().getValues();
  let foundRow = -1;
  
  // Search from bottom to top to find most recent entry
  for (let i = data.length - 1; i >= 1; i--) {
    if (data[i][1] === upiId) {
      foundRow = i + 1; // Return row number (1-indexed)
      break; // Stop at first match (most recent)
    }
  }
  
  return foundRow;
}

// Helper: Find row by Click ID
function findRowByClickId(sheet, clickId) {
  const data = sheet.getDataRange().getValues();
  Logger.log('Searching through ' + (data.length - 1) + ' rows for click_id: ' + clickId);
  
  for (let i = 1; i < data.length; i++) {
    Logger.log('Row ' + i + ' - Click ID: ' + data[i][2]);
    if (data[i][2] === clickId) {
      Logger.log('Match found at row: ' + (i + 1));
      return i + 1; // Return row number (1-indexed)
    }
  }
  
  Logger.log('No match found for click_id: ' + clickId);
  return -1;
}
